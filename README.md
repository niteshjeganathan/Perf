# Perf

## What is Perf? 
* Perf is a profiler tool for Linux based systems
* Abstracts away all hardware differences in Linux performance measurements
* Simple commandline interface

## Commands
* Can collect and analyze performance and trace data
```bash
$ perf

  usage: perf [--version] [--help] [OPTIONS] COMMAND [ARGS]

 The most commonly used perf commands are:
   annotate        Read perf.data (created by perf record) and display annotated code
   archive         Create archive with object files with build-ids found in perf.data file
   bench           General framework for benchmark suites
   buildid-cache   Manage build-id cache.
   buildid-list    List the buildids in a perf.data file
   c2c             Shared Data C2C/HITM Analyzer.
   config          Get and set variables in a configuration file.
   daemon          Run record sessions on background
   data            Data file related processing
   diff            Read perf.data files and display the differential profile
   evlist          List the event names in a perf.data file
   ftrace          simple wrapper for kernel's ftrace functionality
   inject          Filter to augment the events stream with additional information
   iostat          Show I/O performance metrics
   kallsyms        Searches running kernel for symbols
   kvm             Tool to trace/measure kvm guest os
   list            List all symbolic event types
   mem             Profile memory accesses
   record          Run a command and record its profile into perf.data
   report          Read perf.data (created by perf record) and display the profile
   script          Read perf.data (created by perf record) and display trace output
   stat            Run a command and gather performance counter statistics
   test            Runs sanity tests.
   top             System profiling tool.
   version         display the version of perf binary
   probe           Define new dynamic tracepoints

 See 'perf help COMMAND' for more information on a specific command.
```

## Events
* Events refer to specific occurrence or conditions that perf can monitor and analyze
* These events help track CPU performance, memory usage, context switches, cache hits/misses, and many other system metrics.

Different types of events are: 
* Software Events
  * Pure kernel counters
  * These are generated by the Linux kernel rather than the hardware.
  * Example: context switches
* Hardware Events (PMU hardware events)
  * These are events directly provided by the CPUâ€™s Performance Monitoring Unit (PMU).
  * Vary with each processor type and model
  * Example: number of cycles
* PMU Events / Hardware Cache Events
  * More detailed, CPU-specific events accessible via hardware counters.
  * These events get mapped onto an actual events provided by the CPU
  * Confusingly called hardware events as well
  * Exmaple: LLC-loads
* Tracepoint Events
  * Implemented by kernel ftrace infrastructure
  * Kernel-defined tracepoints for monitoring specific kernel events.
  * Example: syscalls:sys_enter_execve: Triggers when a process executes a new binary

 To get a list of supported evenets: 
 ```bash
$ perf list

List of pre-defined events (to be used in -e):

 cpu-cycles OR cycles                       [Hardware event]
 instructions                               [Hardware event]
 cache-references                           [Hardware event]
 cache-misses                               [Hardware event]
 branch-instructions OR branches            [Hardware event]
 branch-misses                              [Hardware event]
 bus-cycles                                 [Hardware event]
 ref-cycles                                 [Hardware event]

 cpu-clock                                  [Software event]
 task-clock                                 [Software event]
 page-faults OR faults                      [Software event]
 minor-faults                               [Software event]
 major-faults                               [Software event]
 context-switches OR cs                     [Software event]
 cpu-migrations OR migrations               [Software event]
 alignment-faults                           [Software event]
 emulation-faults                           [Software event]
 bpf-output                                 [Software event]
 cgroup-switches                            [Software event]
 dummy                                      [Software event]

 L1-dcache-loads                            [Hardware cache event]
 L1-dcache-load-misses                      [Hardware cache event]
 L1-dcache-stores                           [Hardware cache event]
 L1-dcache-store-misses                     [Hardware cache event]
 L1-dcache-prefetches                       [Hardware cache event]
 L1-dcache-prefetch-misses                  [Hardware cache event]
 L1-icache-loads                            [Hardware cache event]
 L1-icache-load-misses                      [Hardware cache event]
 L1-icache-prefetches                       [Hardware cache event]
 L1-icache-prefetch-misses                  [Hardware cache event]
 LLC-loads                                  [Hardware cache event]
 LLC-load-misses                            [Hardware cache event]
 LLC-stores                                 [Hardware cache event]
 LLC-store-misses                           [Hardware cache event]

 LLC-prefetch-misses                        [Hardware cache event]
 dTLB-loads                                 [Hardware cache event]
 dTLB-load-misses                           [Hardware cache event]
 dTLB-stores                                [Hardware cache event]
 dTLB-store-misses                          [Hardware cache event]
 dTLB-prefetches                            [Hardware cache event]
 dTLB-prefetch-misses                       [Hardware cache event]
 iTLB-loads                                 [Hardware cache event]
 iTLB-load-misses                           [Hardware cache event]
 branch-loads                               [Hardware cache event]
 branch-load-misses                         [Hardware cache event]

 rNNN (see 'perf list --help' on how to encode it) [Raw hardware event descriptor]

 mem:<addr>[:access]                        [Hardware breakpoint]

 kvmmmu:kvm_mmu_pagetable_walk              [Tracepoint event]

 [...]

 sched:sched_stat_runtime                   [Tracepoint event]
 sched:sched_pi_setprio                     [Tracepoint event]
 syscalls:sys_enter_socket                  [Tracepoint event]
 syscalls:sys_exit_socket                   [Tracepoint event]

 [...]
```
## Using perf stat
* For all supported events, perf can keep running count during process execution
* In counting modes, the occurrences of events are simply aggregateed and presented on standard output
* With no events specified, it colelcts the common events listed below

```bash
$ perf stat -B dd if=/dev/zero of=/dev/null count=1000000

1000000+0 records in
1000000+0 records out
512000000 bytes (512 MB) copied, 0.956217 s, 535 MB/s

 Performance counter stats for 'dd if=/dev/zero of=/dev/null count=1000000':

            5,099 cache-misses             #      0.005 M/sec (scaled from 66.58%)
          235,384 cache-references         #      0.246 M/sec (scaled from 66.56%)
        9,281,660 branch-misses            #      3.858 %     (scaled from 33.50%)
      240,609,766 branches                 #    251.559 M/sec (scaled from 33.66%)
    1,403,561,257 instructions             #      0.679 IPC   (scaled from 50.23%)
    2,066,201,729 cycles                   #   2160.227 M/sec (scaled from 66.67%)
              217 page-faults              #      0.000 M/sec
                3 CPU-migrations           #      0.000 M/sec
               83 context-switches         #      0.000 M/sec
       956.474238 task-clock-msecs         #      0.999 CPUs

       0.957617512  seconds time elapsed
```

### Options Controlling Event Selection
* By default, events are measured both at user and kernel levels:
```bash
$ perf stat -e cycles dd if=/dev/zero of=/dev/null count=100000
```
* User Level
```bash
$ perf stat -e cycles:u dd if=/dev/zero of=/dev/null count=100000
```
* Kernel Level
```bash
$ perf stat -e cycles:k dd if=/dev/zero of=/dev/null count=100000
```

### Options Controlling Environment Selection
* Per-Thread Mode
  * Counter only monitors the execution of a designated thread
  * When the thread is scheduled out, monitoring stops
  * When a thread is migrated from one processor to another, counters are saved on the current processor and are restored on the new one
* Per-Process Mode
  * Variant of per-thread
  * All threads of the process are monitored
  * Counts and samples are aggregated at the process level
* Per-CPU Mode
  * All threads running on the designated processors are monitored
  * Counts and samples are thus aggregated per CPU
* System-Wide Mode
  * Captures performance data from all CPUs
 
### Options Controlling Output
* Pretty printing large numbers: -B
```bash
LC_NUMERIC=en_US.UTF8 perf stat -B -e cycles:u,instructions:u dd if=/dev/zero of=/dev/null count=10000000

100000+0 records in
100000+0 records out
51200000 bytes (51 MB) copied, 0.0971547 s, 527 MB/s

 Performance counter stats for 'dd if=/dev/zero of=/dev/null count=100000':

       96,551,461 cycles
       38,176,009 instructions             #      0.395 IPC

       0.098556460  seconds time elapsed
```
* Machine readable output: -x
```bash
perf stat  -x, date

Thu May 26 21:11:07 EDT 2011
884,cache-misses
32559,cache-references
<not counted>,branch-misses
<not counted>,branches
<not counted>,instructions
<not counted>,cycles
188,page-faults
2,CPU-migrations
0,context-switches
2.350642,task-clock-msecs
```

## Using perf record
